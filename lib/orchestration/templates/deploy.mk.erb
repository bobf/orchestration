-include .env
export

ifneq (,$(RAILS_ENV))
  env:=$(RAILS_ENV)
else ifneq (,$(RACK_ENV))
  env:=$(RACK_ENV)
endif

verify-environment:
ifndef VIRTUAL_HOST
        @$(error `VIRTUAL_HOST` must be defined in environment)
endif

ifndef LISTEN_PORT
        @$(error `LISTEN_PORT` must be defined in environment)
endif

ifndef env
        @$(error Either `env`, `RACK_ENV` or `RAILS_ENV` must be defined in environment)
endif

compose_base:=env HOST_UID=$(shell id -u) \
              DOCKER_ORGANIZATION=%%ORGANIZATION%% \
              DOCKER_REPOSITORY=%%REPOSITORY%%:%%VERSION%% \
              docker-compose \
              -p %%REPOSITORY%%_${env} \
              -f docker-compose.yml

compose:=${compose_base} -f docker-compose.production.yml -f docker-compose.override.yml

.PHONY: deploy
deploy:
	@echo "Deploying application to Docker swarm..."
	@${compose} config | docker stack deploy --with-registry-auth -c - %%REPOSITORY%%_${env}

.PHONY: stop
stop:
	@echo "Stopping containers..."
	@${compose} down

.PHONY: start
start:
	@echo "Launching application..."
	@${compose} up -d --scale app=$${instances:-1}

.PHONY: config
config:
	@${compose} config

.PHONY: pull
pull:
	@${compose} pull

.PHONY: logs
logs:
	@${compose} logs -f

.PHONY: migrate
migrate:
	@${compose} run --rm app bundle exec rake db:migrate

.PHONY: compose
compose:
	@echo ${compose}
