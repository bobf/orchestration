### Environment setup ###

SHELL:=/bin/bash

-include .env
export

ifneq (,$(env))
  env:=$(env)
else ifneq (,$(RAILS_ENV))
  env:=$(RAILS_ENV)
else ifneq (,$(RACK_ENV))
  env:=$(RACK_ENV)
else
  env:=development
endif

ifeq (,$(wildcard ./bin/rake))
  rake:=RACK_ENV=${env} RAILS_ENV=${env} bundle exec rake
else
  rake:=RACK_ENV=${env} RAILS_ENV=${env} bin/rake
endif

docker_organization:=$(shell bash ./<%= env.orchestration_dir_name %>/yaml.bash docker_organization)
docker_repository:=$(shell bash ./<%= env.orchestration_dir_name %>/yaml.bash docker_repository)

compose_base:=env HOST_UID=$(shell id -u) \
              DOCKER_ORGANIZATION=${docker_organization} \
              DOCKER_REPOSITORY=${docker_repository} \
              docker-compose \
              -p ${docker_repository}_${env} \
              -f <%= env.orchestration_dir_name %>/docker-compose.yml \

git_branch:=$(if $(branch),$(branch),$(shell git rev-parse --abbrev-ref HEAD))
git_version:=$(shell git rev-parse --short --verify ${git_branch})

compose:=${compose_base} -f <%= env.orchestration_dir_name %>/docker-compose.${env}.yml -f <%= env.orchestration_dir_name %>/docker-compose.override.yml

ifneq (,$(wildcard <%= env.orchestration_dir_name %>/docker-compose.local.yml))
  compose:=${compose} -f <%= env.orchestration_dir_name %>/docker-compose.local.yml
endif

### Container management commands ###

.PHONY: start
start:
	@echo "Starting containers..."
ifeq (${env},$(filter ${env},test development))
	@# If our hostname is also known to Docker as a container ID then join
	@# the same network as our dependencies. This allows us to run side-car
	@# dependencies if we are running in a container (e.g. in Jenkins).
	@(docker ps --format "{{.ID}}" | grep -q $(shell hostname) && ${compose} up -d --force-recreate && docker network connect ${docker_repository}_${env}_default $(shell hostname)) || ${compose} up -d --force-recreate
else
	@${compose} up -d --scale app=$${instances:-1}
endif
	@$(MAKE) wait

.PHONY: stop
stop:
	@echo "Stopping containers..."
	@if docker ps --format "{{.ID}}" | grep -q $(shell hostname) ; \
          then \
            ${compose} down && \
            docker network connect ${docker_repository}_${env}_default $(shell hostname) ; \
          else \
            ${compose} down ; \
          fi
	@echo "All containers stopped."

.PHONY: logs
logs:
	@${compose} logs -f

.PHONY: config
config:
	@${compose} config

.PHONY: compose
compose:
	@echo ${compose}

.PHONY: verify
verify: output := $(shell mktemp)
verify:
	@echo "Verifying compose file(s) ..."
	@${compose} config > "${output}" 2>&1 || ( cat "${output}" ; exit 1 )
	@echo "Verification successful."

.PHONY: test-setup
test-setup:
	@$(MAKE) start migrate env=test

### Deployment utility commands ###

.PHONY: bundle
bundle:
	@echo 'Building deployment bundle...'
	@rm -rf <%= env.orchestration_dir_name %>/.deploy/
	@mkdir -p <%= env.orchestration_dir_name %>/.deploy/${docker_repository}/
	@sed -e "s/%%VERSION%%/${git_version}/g" \
             -e "s/%%REPOSITORY%%/${docker_repository}/g" \
             -e "s/%%ORGANIZATION%%/${docker_organization}/g" \
             <%= env.orchestration_dir_name %>/deploy.mk > \
             <%= env.orchestration_dir_name %>/.deploy/${docker_repository}/Makefile
	@cp <%= env.orchestration_dir_name %>/docker-compose.yml \
            <%= env.orchestration_dir_name %>/docker-compose.production.yml \
            <%= env.orchestration_dir_name %>/docker-compose.override.yml \
            <%= env.orchestration_dir_name %>/.deploy/${docker_repository}/
	@tar -C <%= env.orchestration_dir_name %>/.deploy -cf ./deploy.tar ./${docker_repository}
	@echo 'Deployment bundle written to ./deploy.tar'

.PHONY: deploy
deploy:
ifndef manager
	@$(error Missing `manager` parameter: `make deploy manager=swarm-manager.example.com`)
else
	@echo 'Deploying stack via ${manager}...'
endif

ifndef env_file
	$(MAKE) bundle \
     && workdir=$$(mktemp -d) \
     && mv deploy.tar $${workdir}/ \
     && cd $${workdir} \
     && tar xf deploy.tar \
     && cd ${docker_repository} \
     && tar -cf - . | ssh ${manager} 'cd $$(mktemp -d) && chmod 0700 . && cat - | tar -x && make deploy-stack && rm -r $$(pwd)'
else
	$(MAKE) bundle \
     && workdir=$$(mktemp -d) \
     && mv deploy.tar $${workdir}/ \
     && cd $${workdir} \
     && tar xf deploy.tar \
     && cd ${docker_repository} \
     && cp "${env_file}" ./.env \
     && tar -cf - . | ssh ${manager} 'cd $$(mktemp -d) && chmod 0700 . && cat - | tar -x && make deploy-stack && rm -r $$(pwd)'
endif

### Database utility commands ###

.PHONY: migrate
migrate:
	@echo "Running migrations..."
	@(${rake} db:create && ${rake} db:migrate) || ${rake} db:migrate
	@echo "Migrations complete."

.PHONY: migrate-container
migrate-container:
	@echo "[app] Running migrations..."
ifdef env_file
	@cp ${env_file} ./.env
endif
	${compose} run --rm app make migrate
	@echo "[app] Migrations complete."

### Service healthcheck commands ###

.PHONY: wait
wait: <%= wait_commands.join(' ') %>
	@echo "All Containers ready."

## Generic Listener healthcheck for TCP services ##

wait-listener:
	@${rake} orchestration:listener:wait service=${service}

## Test/development wait commands

.PHONY: wait-database
wait-database:
ifeq (${env},$(filter ${env},test development))
	@${rake} orchestration:database:wait
endif

.PHONY: wait-mongo
wait-mongo:
ifeq (${env},$(filter ${env},test development))
	@${rake} orchestration:mongo:wait
endif

.PHONY: wait-rabbitmq
wait-rabbitmq:
ifeq (${env},$(filter ${env},test development))
	@${rake} orchestration:rabbitmq:wait
endif

.PHONY: wait-app
wait-app:
	@# no-op

### Docker build commands ###

.PHONY: build
build:
	@echo "Preparing build from ${git_branch}"
	@mkdir -p ./<%= env.orchestration_dir_name %>/.build
	@git show ${git_branch}:./Gemfile > ./<%= env.orchestration_dir_name %>/.build/Gemfile
	@git show ${git_branch}:./Gemfile.lock > ./<%= env.orchestration_dir_name %>/.build/Gemfile.lock
<% if defined?(Webpacker) %>	@git show ${git_branch}:./package.json > ./<%= env.orchestration_dir_name %>/.build/package.json<% end %>
<% if defined?(Webpacker) %>	@git show ${git_branch}:./yarn.lock > ./<%= env.orchestration_dir_name %>/.build/yarn.lock<% end %>
	@echo "Building..."
	@git archive --format tar.gz -o ./<%= env.orchestration_dir_name %>/.build/context.tar.gz ${git_branch}
	@docker build \
	             --build-arg BUNDLE_GITHUB__COM \
	             --build-arg BUNDLE_BITBUCKET__ORG \
		     -t ${docker_organization}/${docker_repository} \
		     -t ${docker_organization}/${docker_repository}:${git_version} \
		     ./<%= env.orchestration_dir_name %>/
	@echo "Build complete."

.PHONY: push
push:
	docker push ${docker_organization}/${docker_repository}:${git_version}
